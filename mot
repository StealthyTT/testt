blueprint:
  name: Binary Sensor with Zone and Light Control
  description: |
    Turns on the light when the binary sensor detects a change in state inside a specified zone, disables the automation if the light is toggled off and on within a short time,
    and re-enables it if the light has been off for 5 minutes.
  domain: automation
  input:
    binary_sensor:
      name: Binary Sensor
      description: The binary sensor to detect changes in state.
      selector:
        entity:
          domain: binary_sensor
    light_entity:
      name: Light
      description: The light to control.
      selector:
        entity:
          domain: light
    toggle_count_helper:
      name: Toggle Count Helper
      description: The helper to count how many times the light has been toggled.
      selector:
        entity:
          domain: input_number
    automation_enabled_helper:
      name: Automation Enabled Helper
      description: The helper to enable or disable the automation.
      selector:
        entity:
          domain: input_boolean
    reset_timer:
      name: Reset Timer
      description: Timer to reset toggle count after inactivity.
      selector:
        entity:
          domain: timer
    light_off_timer:
      name: Light Off Timer
      description: Timer to track if the light has been off for 5 minutes.
      selector:
        entity:
          domain: timer
    motion_zone:
      name: Motion Zone
      description: The zone where the binary sensor must be located to trigger the automation.
      selector:
        entity:
          domain: zone

trigger:
  - platform: state
    entity_id: !input 'binary_sensor'
    to: "on"
  - platform: state
    entity_id: !input 'motion_zone'
    to: "on"

condition:
  - condition: state
    entity_id: !input 'automation_enabled_helper'
    state: "on"  # Only proceed if automation is enabled
  - condition: zone
    entity_id: !input 'binary_sensor'
    zone: !input 'motion_zone'
    # Trigger only if the binary sensor is in the specified zone

action:
  - service: light.turn_on
    target:
      entity_id: !input 'light_entity'
  
  - service: timer.start
    target:
      entity_id: !input 'reset_timer'  # Start the main reset timer

  - service: input_number.set_value
    target:
      entity_id: !input 'toggle_count_helper'
    data:
      value: 0  # Reset the toggle count
  
  - service: timer.start
    target:
      entity_id: !input 'light_off_timer'  # Start the 5-minute light-off timer
  
  # Monitor the light toggle and count how many times it's toggled
  - choose:
      - conditions:
          - condition: state
            entity_id: !input 'light_entity'
            state: "off"
        sequence:
          - service: input_number.increment
            target:
              entity_id: !input 'toggle_count_helper'
          
          - service: timer.start
            target:
              entity_id: !input 'reset_timer'  # Reset the timer

          - service: ti
